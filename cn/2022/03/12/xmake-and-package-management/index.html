<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>Xmake 和 C/C++ 包管理</title>
    <meta name="description" content="Xmake 是一个基于 Lua 的轻量级跨平台构建工具，关于 Xmake 与构建系统的介绍，我们已经在之前的文章中做了详细的介绍：C/C++ 构建系统，我用 xmake。如果大家已经对 Xmake 已经有了大概的了解，就会知道，它不仅仅是一个构建工具，还内置了对 C/C++ 包管理的支持，我们也可以把 Xmake...">

    
    <meta name="keywords" content="xmake,lua,C/C++,Package,Manager,tboox" />

    <!-- qq oauth -->
    <meta property="qc:admins" content="5211601217706727767255" />

    <!--icon -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" sizes="192x192" href="/static/img/nice-highres.png" />
	<link rel="apple-touch-icon-precomposed" href="/static/img/apple-touch-icon-57x57-precomposed.png" />
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/static/img/apple-touch-icon-72x72-precomposed.png" />
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/static/img/apple-touch-icon-114x114-precomposed.png" />
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/static/img/apple-touch-icon-144x144-precomposed.png" />
	<link rel="apple-touch-icon-precomposed" sizes="180x180" href="/static/img/retinahd_icon.png" />
	<meta name="msapplication-TileImage" content="/static/img/retinahd_icon.png" />

    <link rel="stylesheet" href=" /css/fontawesome/css/font-awesome.min.css ">
    <link rel="stylesheet" href=" /css/main.css ">
    <link rel="canonical" href="https://tboox.org/cn/2022/03/12/xmake-and-package-management/">
    <link rel="alternate" type="application/rss+xml" title="TBOOX Open Source Project" href="https://tboox.org/feed.xml ">
    <link rel="alternate" hreflang="en" href="https://tboox.org/" />
    <link rel="alternate" hreflang="zh-Hans" href="https://tboox.org/cn/" />

    <!-- css -->
    <link href="/css/reward.css" rel="stylesheet" type="text/css">




    <script type="text/javascript">
    function isPC(){
        var userAgentInfo = navigator.userAgent;
        var Agents = new Array("Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod");
        var flag = true;
        for (var v = 0; v < Agents.length; v++) {
            if (userAgentInfo.indexOf(Agents[v]) > 0) { flag = false; break; }
        }
        return flag;
    }
    </script>

<!-- wwads -->

    <script type="text/javascript" charset="UTF-8" src="https://cdn.wwads.cn/js/makemoney.js" async></script>


<!-- baidu ads -->



    <!-- baidu ads -->

</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/cn" class="brand">TBOOX</a>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/?lang=0">
                    
                        <i class="fa fa-home"></i>English
                    </a>
                </li>

                
                    
                    
                    <li>
                        
                            
                            <a href="/cn/project/">
                            
                        
                            <i class="fa fa-bookmark"></i>项目
                        </a>
                    </li>
                    
                    
                
                    
                    
                    
                
                    
                    
                    <li>
                        
                            
                            <a href="/cn/archive/">
                            
                        
                            <i class="fa fa-archive"></i>归档
                        </a>
                    </li>
                    
                    
                
                    
                    
                    
                
                    
                    
                    <li>
                        
                            
                            <a href="/cn/category/">
                            
                        
                            <i class="fa fa-th-list"></i>分类
                        </a>
                    </li>
                    
                    
                
                    
                    
                    
                
                    
                    
                    <li>
                        
                            
                            <a href="/cn/tag/">
                            
                        
                            <i class="fa fa-tags"></i>标记
                        </a>
                    </li>
                    
                    
                
                    
                    
                    
                
                    
                
                    
                    
                    <li>
                        
                            
                            <a href="/cn/docs/">
                            
                        
                            <i class="fa fa-book"></i>文档
                        </a>
                    </li>
                    
                    
                
                    
                    
                    
                
                    
                    
                    <li>
                        
                            
                            <a href="https://xmake.io/#/zh-cn/about/contact" target="_blank" >
                            
                        
                            <i class="fa fa-forumbee"></i>社区
                        </a>
                    </li>
                    
                    
                
                    
                    
                    
                
                    
                    
                    <li>
                        
                            
                            <a href="/cn/donation/">
                            
                        
                            <i class="fa fa-heart"></i>捐助
                        </a>
                    </li>
                    
                    
                
                    
                    
                    
                
                    
                    
                    <li>
                        
                            
                            <a href="/cn/about/">
                            
                        
                            <i class="fa fa-user"></i>关于
                        </a>
                    </li>
                    
                    
                
                    
                    
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                    
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>



        <div class="page clearfix" post>
    <div class="left">
        <h1>Xmake 和 C/C++ 包管理</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2022-03-12
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#xmake" title="Category: xmake" rel="category">xmake</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#xmake" title="Tag: xmake" rel="tag">xmake</a-->
        <a href="/cn/tag/#xmake" title="Tag: xmake" rel="tag">xmake</a>&nbsp;
    
        <!--a href="/tag/#lua" title="Tag: lua" rel="tag">lua</a-->
        <a href="/cn/tag/#lua" title="Tag: lua" rel="tag">lua</a>&nbsp;
    
        <!--a href="/tag/#C%2FC%2B%2B" title="Tag: C/C++" rel="tag">C/C++</a-->
        <a href="/cn/tag/#C/C++" title="Tag: C/C++" rel="tag">C/C++</a>&nbsp;
    
        <!--a href="/tag/#Package" title="Tag: Package" rel="tag">Package</a-->
        <a href="/cn/tag/#Package" title="Tag: Package" rel="tag">Package</a>&nbsp;
    
        <!--a href="/tag/#Manager" title="Tag: Manager" rel="tag">Manager</a-->
        <a href="/cn/tag/#Manager" title="Tag: Manager" rel="tag">Manager</a>
    
  

</span>

            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <p><a href="https://github.com/xmake-io/xmake">Xmake</a> 是一个基于 Lua 的轻量级跨平台构建工具，关于 Xmake 与构建系统的介绍，我们已经在之前的文章中做了详细的介绍：<a href="https://zhuanlan.zhihu.com/p/370008884">C/C++ 构建系统，我用 xmake</a>。</p>

<p>如果大家已经对 Xmake 已经有了大概的了解，就会知道，它不仅仅是一个构建工具，还内置了对 C/C++ 包管理的支持，我们也可以把 Xmake 理解为：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Xmake = Build backend + Project Generator + Package Manager
</code></pre>
</div>

<p>经过几年的持续迭代，Xmake 对 C/C++ 包管理的支持不断完善，也新增了不少实用的包管理特性，因此，在本文中，我们对其做一些总结，希望对大家有所帮助。</p>

<ul>
  <li><a href="https://github.com/xmake-io/xmake">项目源码</a></li>
  <li><a href="https://xmake.io/#/zh-cn/">官方文档</a></li>
  <li><a href="https://xmake.io/#/zh-cn/about/course">入门课程</a></li>
</ul>

<h3 id="构建系统与包管理">构建系统与包管理</h3>

<p>C++ 的生态比较繁杂，这其中也有一定历史原因，不管如何，官方没有提供原生的包管理支持，对我们开发者来说，使用第三方 C++ 依赖库多少存在很多不便。</p>

<p>其实，现在已经有很多强大的 C/C++ 包管理器，最知名，用的最多的有：vcpkg, conan, conda 等等，它们虽然很强大，但是有一个共同的问题：构建工具对它们没有提供原生的支持。</p>

<p>由于 CMake 对它们没有提供内置支持，想在 CMake 中使用它们集成依赖包非常繁琐，并且集成和使用的方式都不一致。</p>

<h4 id="在-cmake-中使用-conan">在 CMake 中使用 Conan</h4>

<p>在 CMake 中使用 conan 集成 C/C++ 包，我们需要提供额外的 CMake Wrapper 脚本，以类似插件的方式注入进自己的工程中去。</p>

<div class="language-cmake highlighter-rouge"><pre class="highlight"><code><span class="nb">cmake_minimum_required</span><span class="p">(</span>VERSION 3.5<span class="p">)</span>
<span class="nb">project</span><span class="p">(</span>FormatOutput CXX<span class="p">)</span>

<span class="nb">list</span><span class="p">(</span>APPEND CMAKE_MODULE_PATH <span class="si">${</span><span class="nv">CMAKE_BINARY_DIR</span><span class="si">}</span><span class="p">)</span>
<span class="nb">list</span><span class="p">(</span>APPEND CMAKE_PREFIX_PATH <span class="si">${</span><span class="nv">CMAKE_BINARY_DIR</span><span class="si">}</span><span class="p">)</span>

<span class="nb">add_definitions</span><span class="p">(</span><span class="s2">"-std=c++11"</span><span class="p">)</span>

<span class="nb">if</span><span class="p">(</span>NOT EXISTS <span class="s2">"</span><span class="si">${</span><span class="nv">CMAKE_BINARY_DIR</span><span class="si">}</span><span class="s2">/conan.cmake"</span><span class="p">)</span>
  <span class="nb">message</span><span class="p">(</span>STATUS <span class="s2">"Downloading conan.cmake from https://github.com/conan-io/cmake-conan"</span><span class="p">)</span>
  <span class="nb">file</span><span class="p">(</span>DOWNLOAD <span class="s2">"https://raw.githubusercontent.com/conan-io/cmake-conan/v0.16.1/conan.cmake"</span>
                <span class="s2">"</span><span class="si">${</span><span class="nv">CMAKE_BINARY_DIR</span><span class="si">}</span><span class="s2">/conan.cmake"</span>
                EXPECTED_HASH SHA256=396e16d0f5eabdc6a14afddbcfff62a54a7ee75c6da23f32f7a31bc85db23484
                TLS_VERIFY ON<span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="nb">include</span><span class="p">(</span><span class="si">${</span><span class="nv">CMAKE_BINARY_DIR</span><span class="si">}</span>/conan.cmake<span class="p">)</span>

<span class="nf">conan_cmake_configure</span><span class="p">(</span>REQUIRES fmt/6.1.2
                      GENERATORS cmake_find_package<span class="p">)</span>

<span class="nf">conan_cmake_autodetect</span><span class="p">(</span>settings<span class="p">)</span>

<span class="nf">conan_cmake_install</span><span class="p">(</span>PATH_OR_REFERENCE .
                    BUILD missing
                    REMOTE conancenter
                    SETTINGS <span class="si">${</span><span class="nv">settings</span><span class="si">}</span><span class="p">)</span>

<span class="nb">find_package</span><span class="p">(</span>fmt<span class="p">)</span>

<span class="nb">add_executable</span><span class="p">(</span>main main.cpp<span class="p">)</span>
<span class="nb">target_link_libraries</span><span class="p">(</span>main fmt::fmt<span class="p">)</span>
</code></pre>
</div>

<p>为了集成一个包，需要额外配置很多的脚本。</p>

<h4 id="在-cmake-中使用-vcpkg">在 CMake 中使用 Vcpkg</h4>

<p>在 CMake 中使用 vcpkg 集成包，我们也需要额外注入一个工具链脚本文件。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>cmake -B <span class="o">[</span>build directory] -S . -DCMAKE_TOOLCHAIN_FILE<span class="o">=[</span>path to vcpkg]/scripts/buildsystems/vcpkg.cmake
cmake --build <span class="o">[</span>build directory]
</code></pre>
</div>

<p>另外，还有一个问题，就是我们还需要额外自己调用 <code class="highlighter-rouge">vcpkg install [packages]</code> 命令，去安装包。</p>

<p>这其中每一个环节，对于用户来讲都需要额外的探索过程，没法做到真正的一键编译。</p>

<p>想象下，用户下载了一个集成了 vcpkg 包的 cmake 项目，想要编译通过，除了项目配置，还需要做哪些额外的事情：</p>

<ol>
  <li>安装 vcpkg</li>
  <li>执行 <code class="highlighter-rouge">vcpkg install xxx</code> 安装里面需要的包</li>
  <li>执行 cmake 传递 vcpkg.cmake 脚本给 cmake，进行工程配置</li>
</ol>

<h4 id="在-cmake-中使用-fetchcontent">在 CMake 中使用 FetchContent</h4>

<p>提供了 FetchContent 模式来管理依赖，但似乎是源码拉取，而且必须依赖也是基于 CMake 维护构建的，另外，我们需要对每个依赖项，配置 url, 版本等各种包信息。</p>

<div class="language-cmake highlighter-rouge"><pre class="highlight"><code><span class="nb">cmake_minimum_required</span><span class="p">(</span>VERSION 3.14<span class="p">)</span>
<span class="nb">project</span><span class="p">(</span>fetchContent_example CXX<span class="p">)</span>

<span class="nb">include</span><span class="p">(</span>FetchContent<span class="p">)</span>

<span class="nf">FetchContent_Declare</span><span class="p">(</span>
        DocTest
        GIT_REPOSITORY <span class="s2">"https://github.com/onqtam/doctest"</span>
        GIT_TAG <span class="s2">"932a2ca50666138256dae56fbb16db3b1cae133a"</span>
<span class="p">)</span>
<span class="nf">FetchContent_Declare</span><span class="p">(</span>
        Range-v3
        GIT_REPOSITORY <span class="s2">"https://github.com/ericniebler/range-v3"</span>
        GIT_TAG <span class="s2">"4d6a463bca51bc316f9b565edd94e82388206093"</span>
<span class="p">)</span>

<span class="nf">FetchContent_MakeAvailable</span><span class="p">(</span>DocTest Range-v3<span class="p">)</span>

<span class="nb">add_executable</span><span class="p">(</span><span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span> src/main.cpp<span class="p">)</span>
<span class="nb">target_link_libraries</span><span class="p">(</span><span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span> doctest range-v3<span class="p">)</span>
</code></pre>
</div>

<h4 id="在-meson-中使用依赖包">在 Meson 中使用依赖包</h4>

<p>Meson 很强大，并且也提供了自带的包管理支持，但是想要在 Meson 中使用其他包管理器，例如 vcpkg/conan 等等同样很繁琐，并没有提供原生支持。</p>

<h4 id="在-xmake-中使用依赖包">在 Xmake 中使用依赖包</h4>

<p>Xmake 不仅提供了内置的 <a href="https://github.com/xmake-io/xmake-repo">xmake-repo</a> 内置的包管理仓库，可以直接集成使用里面的包，还支持以相同的集成方式，去快速集成 vcpkg/conan 等第三方的依赖包。</p>

<p>集成一个内置依赖包只需要几行配置：</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"zlib 1.2.11"</span><span class="p">)</span>
<span class="n">target</span><span class="p">(</span><span class="s2">"test"</span><span class="p">)</span>
    <span class="n">add_files</span><span class="p">(</span><span class="s2">"src/*.c"</span><span class="p">)</span>
    <span class="n">add_packages</span><span class="p">(</span><span class="s2">"zlib"</span><span class="p">)</span>
</code></pre>
</div>

<p>集成一个 vcpkg 包，仅仅只需要加上对应的包管理器命名空间，集成方式完全相同：</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"vcpkg::zlib 1.2.11"</span><span class="p">)</span>
<span class="n">target</span><span class="p">(</span><span class="s2">"test"</span><span class="p">)</span>
    <span class="n">add_files</span><span class="p">(</span><span class="s2">"src/*.c"</span><span class="p">)</span>
    <span class="n">add_packages</span><span class="p">(</span><span class="s2">"vcpkg::zlib"</span><span class="p">)</span>
</code></pre>
</div>

<p>集成一个 conan 包，或者 conda, homebrew, pacman, apt, clib 等第三方包，也只需要改成 <code class="highlighter-rouge">conan::zlib</code> 就行了，用户可以随意切换包源。</p>

<p>另外，Xmake 会自动帮你调用 <code class="highlighter-rouge">vcpkg/conan install</code> 安装命令去安装依赖包，然后集成它们，不需要用户做任何其他事情，仅仅只需要执行 <code class="highlighter-rouge">xmake</code> 一键编译。</p>

<p><img src="https://xmake.io/assets/img/index/package_manage.png" width="650px" /></p>

<h3 id="cc-包太少">C/C++ 包太少？</h3>

<p>觉得 Xmake 内置的包仓库里面的包太少么？完全没关系，理论上，你可以通过 Xmake 使用整个 C/C++ 生态 90% 的常用依赖包，就是因为 Xmake 可以快速从各种其他包管理器中集成包来使用。</p>

<p>目前 Xmake 支持的包源有以下这些：</p>

<ul>
  <li>Official package repository <a href="https://github.com/xmake-io/xmake-repo">xmake-repo</a> (tbox &gt;1.6.1)</li>
  <li>Official package manager <a href="https://github.com/xmake-io/xrepo">Xrepo</a></li>
  <li><a href="https://xmake.io/#/package/remote_package?id=using-self-built-private-package-repository">User-built repositories</a></li>
  <li>Conan (conan::openssl/1.1.1g)</li>
  <li>Conda (conda::libpng 1.3.67)</li>
  <li>Vcpkg (vcpkg:ffmpeg)</li>
  <li>Homebrew/Linuxbrew (brew::pcre2/libpcre2-8)</li>
  <li>Pacman on archlinux/msys2 (pacman::libcurl)</li>
  <li>Apt on ubuntu/debian (apt::zlib1g-dev)</li>
  <li>Clib (clib::clibs/bytes@0.0.4)</li>
  <li>Dub (dub::log 0.4.3)</li>
  <li>Portage on Gentoo/Linux (portage::libhandy)</li>
  <li>Nimble for nimlang (nimble::zip &gt;1.3)</li>
  <li>Cargo for rust (cargo::base64 0.13.0)</li>
</ul>

<p>基本上，这些仓库基本已经覆盖了 C/C++ 用户日常所需的所有包。</p>

<p>作者从写这篇文章开始，统计了下 vcpkg/conan/xmake-repo 仓库的包数量：</p>

<ul>
  <li>vcpkg: 1859</li>
  <li>conan: 1218</li>
  <li>xmake-repo: 651</li>
</ul>

<p>可以看到，目前 Xmake 内置仓库的包数量，已经快要接近 vcpkg/conan 了，也不少了，我们也在不断的收录新的包进来。</p>

<p>但是这完全没有关系，因为我们可以使用任意包仓库中的包。</p>

<p>如果在 CMake 中使用 vcpkg，我们只能使用 1859 个包。
如果在 CMake 中使用 conan，我们只能使用 1218 个包。</p>

<p>而如果在 Xmake 中使用包，我们可以使用 651 (xmake-repo) + vcpkg/conan (1k+) + more (conda, homebrew, pacman, apt, clib …) 中的包。</p>

<p>甚至，C/C++ 包不够，其他语言的包也可以拿过来用，例如：Xmake 也支持从 dub/cargo 等 Dlang/Rust 的包管理器中拉取包，给 C/C++ 项目使用。</p>

<h3 id="xmake-内置包管理集成">Xmake 内置包管理集成</h3>

<p>除了接入第三方包管理，我们也更推荐优先使用集成 xmake-repo 内置仓库中提供的包，Xmake 会提供更多特性支持。</p>

<p>因此，如果用户需要的包还没被收录，可以先尝试提交到 <a href="https://github.com/xmake-io/xmake-repo">xmake-repo</a> 进来。</p>

<p>接下来，我们系统介绍下，集成内置包的一些特性。</p>

<h4 id="语义版本设置">语义版本设置</h4>

<p>Xmake 的依赖包管理是完全支持语义版本选择的，例如：”~1.6.1”，对于语义版本的具体描述见：<a href="https://semver.org/">https://semver.org/</a></p>

<p>比如下面一些语义版本写法：</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"tbox 1.6.*"</span><span class="p">,</span> <span class="s2">"pcre 1.3.x"</span><span class="p">,</span> <span class="s2">"libpng ^1.18"</span><span class="p">)</span>
<span class="n">add_requires</span><span class="p">(</span><span class="s2">"libpng ~1.16"</span><span class="p">,</span> <span class="s2">"zlib 1.1.2 || &gt;=1.2.11 &lt;1.3.0"</span><span class="p">)</span>
</code></pre>
</div>

<p>当然，如果我们对当前的依赖包的版本没有特殊要求，那么可以直接这么写：</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"tbox"</span><span class="p">,</span> <span class="s2">"libpng"</span><span class="p">,</span> <span class="s2">"zlib"</span><span class="p">)</span>
</code></pre>
</div>

<p>这会使用已知的最新版本包，或者是master分支的源码编译的包，如果当前包有git repo地址，我们也能指定特定分支版本：</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"tbox master"</span><span class="p">)</span>
<span class="n">add_requires</span><span class="p">(</span><span class="s2">"tbox dev"</span><span class="p">)</span>
</code></pre>
</div>

<p>Xmake 的语义版本支持，在几年前就已经很好的支持，而 vcpkg 也仅仅在最近一年才通过清单模式勉强支持它。</p>

<p>即使现在，vcpkg 对版本语义的支持也很受限，只能支持 <code class="highlighter-rouge">&gt;=1.0</code>, <code class="highlighter-rouge">1.0</code> 等几种版本模式，想要选择任意版本的包，比如 <code class="highlighter-rouge">&gt;=1.0 &lt;1.5</code> 等复杂版本条件的包，vcpkg 还是无法支持。</p>

<h4 id="可选包设置">可选包设置</h4>

<p>如果指定的依赖包当前平台不支持，或者编译安装失败了，那么 Xmake 会编译报错，这对于有些必须要依赖某些包才能工作的项目，这是合理的。
但是如果有些包是可选的依赖，即使没有也可以正常编译使用的话，可以设置为可选包：</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"tbox"</span><span class="p">,</span> <span class="p">{</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">true</span><span class="p">})</span>
</code></pre>
</div>

<h4 id="使用系统库">使用系统库</h4>

<p>默认的设置，Xmake 会去优先检测系统库是否存在（如果没设置版本要求），如果用户完全不想使用系统库以及第三方包管理提供的库，那么可以设置：</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"tbox"</span><span class="p">,</span> <span class="p">{</span><span class="n">system</span> <span class="o">=</span> <span class="kc">false</span><span class="p">})</span>
</code></pre>
</div>

<p>而如果配置成：</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"tbox"</span><span class="p">,</span> <span class="p">{</span><span class="n">system</span> <span class="o">=</span> <span class="kc">true</span><span class="p">})</span>
</code></pre>
</div>

<p>就是仅仅查找使用系统库，不会去远程下载安装它，这类似于 CMake 的 find_package，但是集成方式更加简单一致。</p>

<h4 id="使用调试版本的包">使用调试版本的包</h4>

<p>如果我们想同时源码调试依赖包，那么可以设置为使用debug版本的包（当然前提是这个包支持debug编译）：</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"tbox"</span><span class="p">,</span> <span class="p">{</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">true</span><span class="p">})</span>
</code></pre>
</div>

<h4 id="启用包的可选特性">启用包的可选特性</h4>

<p>我们也可以安装带有指定特性的包，比如安装开启了 zlib 和 libx265 的 ffmpeg 包。</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"ffmpeg"</span><span class="p">,</span> <span class="p">{</span><span class="n">configs</span> <span class="o">=</span> <span class="p">{</span><span class="n">zlib</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">libx265</span> <span class="o">=</span> <span class="kc">true</span><span class="p">}})</span>
</code></pre>
</div>

<h4 id="传递额外的编译选项">传递额外的编译选项</h4>

<p>我们也可以传递额外的编译选项给包：</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"spdlog"</span><span class="p">,</span> <span class="p">{</span><span class="n">configs</span> <span class="o">=</span> <span class="p">{</span><span class="n">cxflags</span> <span class="o">=</span> <span class="s2">"-Dxxx"</span><span class="p">}})</span>
</code></pre>
</div>

<h3 id="独立的包管理命令-xrepo">独立的包管理命令 Xrepo</h3>

<p>Xrepo 是一个基于 <a href="https://github.com/xmake-io/xmake">Xmake</a> 的跨平台 C/C++ 包管理器。</p>

<p>它是一个独立于 Xmake 的命令程序，用于辅助用户去管理依赖包，类似 vcpkg/conan，但相比它们，有额外多了一些实用的特性，我们会简单介绍一些。</p>

<p><img src="https://xrepo.xmake.io/assets/img/xrepo.gif" alt="" /></p>

<h4 id="多仓库管理">多仓库管理</h4>

<p>除了可以直接从官方仓库：<a href="https://github.com/xmake-io/xmake-repo">xmake-repo</a> 检索安装包之外，
我们还可以添加任意多个自建的仓库，甚至可以完全隔离外网，仅仅在公司内部网络维护私有包的安装集成。</p>

<p>只需要通过下面的命令，添加上自己的仓库地址：</p>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> add-repo myrepo https://github.com/mygroup/myrepo
</span></code></pre>
</div>

<h4 id="基本使用">基本使用</h4>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> install zlib tbox
</span></code></pre>
</div>

<h4 id="安装指定版本包">安装指定版本包</h4>

<p>完整支持 Semantic Versioning (语义版本)。</p>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> install "zlib 1.2.x"
</span><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> install "zlib &gt;=1.2.0"
</span></code></pre>
</div>

<h4 id="安装指定平台包">安装指定平台包</h4>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> install -p iphoneos -a arm64 zlib
</span><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> install -p android [--ndk=/xxx] zlib
</span><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> install -p mingw [--mingw=/xxx] zlib
</span><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> install -p cross --sdk=/xxx/arm-linux-musleabi-cross zlib
</span></code></pre>
</div>

<h4 id="安装调试版本包">安装调试版本包</h4>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> install -m debug zlib
</span></code></pre>
</div>

<h4 id="安装动态库版本包">安装动态库版本包</h4>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> install -k shared zlib
</span></code></pre>
</div>

<h4 id="安装指定配置包">安装指定配置包</h4>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> install -f "vs_runtime=MD" zlib
</span><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> install -f "regex=true,thread=true" boost
</span></code></pre>
</div>

<h4 id="安装第三方包管理器的包">安装第三方包管理器的包</h4>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> install brew::zlib
</span><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> install vcpkg::zlib
</span><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> install conan::zlib/1.2.11
</span></code></pre>
</div>

<h4 id="查看包的库使用信息">查看包的库使用信息</h4>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> fetch pcre2
</span>{
  {
    linkdirs = {
      "/usr/local/Cellar/pcre2/10.33/lib"
    },
    links = {
      "pcre2-8"
    },
    defines = {
      "PCRE2_CODE_UNIT_WIDTH=8"
    },
    includedirs = "/usr/local/Cellar/pcre2/10.33/include"
  }
}
</code></pre>
</div>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> fetch --ldflags openssl
</span>-L/Users/ruki/.xmake/packages/o/openssl/1.1.1/d639b7d6e3244216b403b39df5101abf/lib -lcrypto -lssl
</code></pre>
</div>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> fetch --cflags openssl
</span>-I/Users/ruki/.xmake/packages/o/openssl/1.1.1/d639b7d6e3244216b403b39df5101abf/include
</code></pre>
</div>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> fetch -p [iphoneos|android] --cflags "zlib 1.2.x"
</span>-I/Users/ruki/.xmake/packages/z/zlib/1.2.11/df72d410e7e14391b1a4375d868a240c/include
</code></pre>
</div>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> fetch --cflags --ldflags conan::zlib/1.2.11
</span>-I/Users/ruki/.conan/data/zlib/1.2.11/_/_/package/f74366f76f700cc6e991285892ad7a23c30e6d47/include -L/Users/ruki/.conan/data/zlib/1.2.11/_/_/package/f74366f76f700cc6e991285892ad7a23c30e6d47/lib -lz
</code></pre>
</div>

<h4 id="导入导出安装后的包">导入导出安装后的包</h4>

<p>xrepo 可以快速导出已经安装后的包，包括对应的库文件，头文件等等。</p>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> export -o /tmp/output zlib
</span></code></pre>
</div>

<p>也可以在其他机器上导入之前导出的安装包，实现包的迁移。</p>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> import -i /xxx/packagedir zlib
</span></code></pre>
</div>

<h4 id="搜索支持的包">搜索支持的包</h4>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> search zlib "pcr*"
</span>    zlib:
      -&gt; zlib: A Massively Spiffy Yet Delicately Unobtrusive Compression Library (in xmake-repo)
    pcr*:
      -&gt; pcre2: A Perl Compatible Regular Expressions Library (in xmake-repo)
      -&gt; pcre: A Perl Compatible Regular Expressions Library (in xmake-repo)
</code></pre>
</div>

<p>另外，现在还可以从 vcpkg, conan, conda 以及 apt 等第三方包管理器中搜索它们的包，只需要加上对应的包命名空间就行，例如：</p>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> search vcpkg::pcre
</span>The package names:
    vcpkg::pcre:
      -&gt; vcpkg::pcre-8.44#8: Perl Compatible Regular Expressions
      -&gt; vcpkg::pcre2-10.35#2: PCRE2 is a re-working of the original Perl Compatible Regular Expressions library
</code></pre>
</div>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> search conan::openssl
</span>The package names:
    conan::openssl:
      -&gt; conan::openssl/1.1.1g:
      -&gt; conan::openssl/1.1.1h:
</code></pre>
</div>

<h4 id="包虚拟环境管理">包虚拟环境管理</h4>

<p>我们可以通过在当前目录下，添加 xmake.lua 文件，定制化一些包配置，然后进入特定的包 shell 环境。</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"zlib 1.2.11"</span><span class="p">)</span>
<span class="n">add_requires</span><span class="p">(</span><span class="s2">"python 3.x"</span><span class="p">,</span> <span class="s2">"luajit"</span><span class="p">)</span>
</code></pre>
</div>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">xrepo</span><span class="kv"> env shell
</span>&gt; python --version
&gt; luajit --version
</code></pre>
</div>

<h3 id="在-xmake-中集成第三方构建系统">在 Xmake 中集成第三方构建系统</h3>

<h4 id="在-xmake-中集成-cmake-项目">在 Xmake 中集成 Cmake 项目</h4>

<p>Xmake 并不打算分裂 C/C++ 生态，它能很好和兼容复用现有 cmake/autoconf/meson 维护的项目，比如可以将一些其他使用 CMake 维护的代码库，直接本地集成进来，参与混合编译。</p>

<p>也就是说，Xmake 不会强制用户将所有的项目重新 port 到 xmake.lua，现有的 CMake 项目，一样可以快速集成到 Xmake 项目中去。</p>

<p>例如，我们有如下项目结构：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>├── foo
│   ├── CMakeLists.txt
│   └── src
│       ├── foo.c
│       └── foo.h
├── src
│   └── main.c
├── test.lua
└── xmake.lua
</code></pre>
</div>

<p>foo 目录下是一个使用 CMake 维护的静态库，而根目录下使用了 Xmake 来维护，我们可以在 xmake.lua 中通过定义 <code class="highlighter-rouge">package("foo")</code> 包来描述如何构建 foo 代码库。</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_rules</span><span class="p">(</span><span class="s2">"mode.debug"</span><span class="p">,</span> <span class="s2">"mode.release"</span><span class="p">)</span>

<span class="n">package</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">)</span>
    <span class="n">add_deps</span><span class="p">(</span><span class="s2">"cmake"</span><span class="p">)</span>
    <span class="n">set_sourcedir</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">scriptdir</span><span class="p">(),</span> <span class="s2">"foo"</span><span class="p">))</span>
    <span class="n">on_install</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="n">package</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">configs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">table.insert</span><span class="p">(</span><span class="n">configs</span><span class="p">,</span> <span class="s2">"-DCMAKE_BUILD_TYPE="</span> <span class="o">..</span> <span class="p">(</span><span class="n">package</span><span class="p">:</span><span class="n">debug</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">"Debug"</span> <span class="ow">or</span> <span class="s2">"Release"</span><span class="p">))</span>
        <span class="nb">table.insert</span><span class="p">(</span><span class="n">configs</span><span class="p">,</span> <span class="s2">"-DBUILD_SHARED_LIBS="</span> <span class="o">..</span> <span class="p">(</span><span class="n">package</span><span class="p">:</span><span class="n">config</span><span class="p">(</span><span class="s2">"shared"</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"ON"</span> <span class="ow">or</span> <span class="s2">"OFF"</span><span class="p">))</span>
        <span class="n">import</span><span class="p">(</span><span class="s2">"package.tools.cmake"</span><span class="p">).</span><span class="n">install</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">configs</span><span class="p">)</span>
    <span class="k">end</span><span class="p">)</span>
    <span class="n">on_test</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="n">package</span><span class="p">)</span>
        <span class="nb">assert</span><span class="p">(</span><span class="n">package</span><span class="p">:</span><span class="n">has_cfuncs</span><span class="p">(</span><span class="s2">"add"</span><span class="p">,</span> <span class="p">{</span><span class="n">includes</span> <span class="o">=</span> <span class="s2">"foo.h"</span><span class="p">}))</span>
    <span class="k">end</span><span class="p">)</span>
<span class="n">package_end</span><span class="p">()</span>

<span class="n">add_requires</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">)</span>

<span class="n">target</span><span class="p">(</span><span class="s2">"demo"</span><span class="p">)</span>
    <span class="n">set_kind</span><span class="p">(</span><span class="s2">"binary"</span><span class="p">)</span>
    <span class="n">add_files</span><span class="p">(</span><span class="s2">"src/main.c"</span><span class="p">)</span>
    <span class="n">add_packages</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">)</span>
</code></pre>
</div>

<p>其中，我们通过 <code class="highlighter-rouge">set_sourcedir()</code> 来设置 foo 包的代码目录位置，然后通过 import 导入 <code class="highlighter-rouge">package.tools.cmake</code> 辅助模块来调用 cmake 构建代码，xmake 会自动获取生成的 libfoo.a 和对应的头文件。</p>

<p>!&gt; 如果仅仅本地源码集成，我们不需要额外设置 <code class="highlighter-rouge">add_urls</code> 和 <code class="highlighter-rouge">add_versions</code>。</p>

<p>关于包的配置描述，详情见：<a href="https://xmake.io/#/zh-cn/package/remote_package?id=%e5%8c%85%e6%8f%8f%e8%bf%b0%e8%af%b4%e6%98%8e">包描述说明</a></p>

<p>定义完包后，我们就可以通过 <code class="highlighter-rouge">add_requires("foo")</code> 和 <code class="highlighter-rouge">add_packages("foo")</code> 来集成使用它了，就跟集成远程包一样的使用方式。</p>

<p>另外，<code class="highlighter-rouge">on_test</code> 是可选的，如果想要严格检测包的编译安装是否成功，可以在里面做一些测试。</p>

<p>完整例子见：<a href="https://github.com/xmake-io/xmake/tree/master/tests/projects/c/library_with_cmakelists">Library with CMakeLists</a></p>

<h4 id="在-xmake-中集成-meson-项目">在 Xmake 中集成 Meson 项目</h4>

<p>Xmake 支持集成更多其他构建系统维护的第三方源码库，比如 Meson，仅仅只需要导入使用 <code class="highlighter-rouge">package.tools.meson</code> 辅助构建模块调用 meson 来构建它们。</p>

<p>例如，我们从 xmake-repo 仓库中挑选一个使用 meson 构建的包作为例子：</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">package</span><span class="p">(</span><span class="s2">"harfbuzz"</span><span class="p">)</span>
    <span class="n">set_sourcedir</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">scriptdir</span><span class="p">(),</span> <span class="s2">"3rd/harfbuzz"</span><span class="p">))</span>
    <span class="n">add_deps</span><span class="p">(</span><span class="s2">"meson"</span><span class="p">)</span>
    <span class="n">on_install</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="n">package</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">configs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"-Dtests=disabled"</span><span class="p">,</span> <span class="s2">"-Ddocs=disabled"</span><span class="p">,</span> <span class="s2">"-Dbenchmark=disabled"</span><span class="p">,</span> <span class="s2">"-Dcairo=disabled"</span><span class="p">,</span> <span class="s2">"-Dfontconfig=disabled"</span><span class="p">,</span> <span class="s2">"-Dglib=disabled"</span><span class="p">,</span> <span class="s2">"-Dgobject=disabled"</span><span class="p">}</span>
        <span class="nb">table.insert</span><span class="p">(</span><span class="n">configs</span><span class="p">,</span> <span class="s2">"-Ddefault_library="</span> <span class="o">..</span> <span class="p">(</span><span class="n">package</span><span class="p">:</span><span class="n">config</span><span class="p">(</span><span class="s2">"shared"</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"shared"</span> <span class="ow">or</span> <span class="s2">"static"</span><span class="p">))</span>
        <span class="n">import</span><span class="p">(</span><span class="s2">"package.tools.meson"</span><span class="p">).</span><span class="n">install</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">configs</span><span class="p">)</span>
    <span class="k">end</span><span class="p">)</span>
</code></pre>
</div>

<h4 id="在-xmake-中集成-autoconf-项目">在 Xmake 中集成 Autoconf 项目</h4>

<p>我们也可以使用 <code class="highlighter-rouge">package.tools.autoconf</code> 来本地集成带有 autoconf 维护的第三方代码库。</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">package</span><span class="p">(</span><span class="s2">"libev"</span><span class="p">)</span>
    <span class="n">set_sourcedir</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">scriptdir</span><span class="p">(),</span> <span class="s2">"3rd/libev"</span><span class="p">))</span>
    <span class="n">on_install</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="n">package</span><span class="p">)</span>
        <span class="n">import</span><span class="p">(</span><span class="s2">"package.tools.autoconf"</span><span class="p">).</span><span class="n">install</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
    <span class="k">end</span><span class="p">)</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">package.tools.autoconf</code> 和 <code class="highlighter-rouge">package.tools.cmake</code> 模块都是可以支持 mingw/cross/iphoneos/android 等交叉编译平台和工具链的，xmake 会自动传递对应的工具链进去，用户不需要做任何其他事情。</p>

<h4 id="在-xmake-中集成-gn-项目">在 Xmake 中集成 Gn 项目</h4>

<p>我们也可以使用 <code class="highlighter-rouge">package.tools.gn</code> 来本地集成带有 GN 维护的第三方代码库。</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">package</span><span class="p">(</span><span class="s2">"skia"</span><span class="p">)</span>
    <span class="n">set_sourcedir</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">scriptdir</span><span class="p">(),</span> <span class="s2">"3rd/skia"</span><span class="p">))</span>
    <span class="n">add_deps</span><span class="p">(</span><span class="s2">"gn"</span><span class="p">,</span> <span class="s2">"ninja"</span><span class="p">)</span>
    <span class="n">on_install</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="n">package</span><span class="p">)</span>
        <span class="n">import</span><span class="p">(</span><span class="s2">"package.tools.gn"</span><span class="p">).</span><span class="n">install</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
    <span class="k">end</span><span class="p">)</span>
</code></pre>
</div>

<p>这里有完整的脚本例子：<a href="https://github.com/xmake-io/xmake-repo/blob/master/packages/s/skia/xmake.lua">Skia with GN</a></p>

<h3 id="在-xmake-中查找使用-cmakec-包">在 Xmake 中查找使用 CMake/C++ 包</h3>

<p>现在 CMake 已经是事实上的标准，所以 CMake 提供的 find_package 已经可以查找大量的系统库和模块，我们也可以完全复用 CMake 的这部分生态来扩充 xmake 对包的集成。</p>

<p>只需要像集成 vcpkg/conan 包那样，将包命名空间改成 <code class="highlighter-rouge">cmake::</code> 就可以了。</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"cmake::ZLIB"</span><span class="p">,</span> <span class="p">{</span><span class="n">alias</span> <span class="o">=</span> <span class="s2">"zlib"</span><span class="p">,</span> <span class="n">system</span> <span class="o">=</span> <span class="kc">true</span><span class="p">})</span>
<span class="n">target</span><span class="p">(</span><span class="s2">"test"</span><span class="p">)</span>
    <span class="n">set_kind</span><span class="p">(</span><span class="s2">"binary"</span><span class="p">)</span>
    <span class="n">add_files</span><span class="p">(</span><span class="s2">"src/*.c"</span><span class="p">)</span>
    <span class="n">add_packages</span><span class="p">(</span><span class="s2">"zlib"</span><span class="p">)</span>
</code></pre>
</div>

<p>我们指定 <code class="highlighter-rouge">system = true</code> 告诉 xmake 强制从系统中调用 cmake 查找包，如果找不到，不再走安装逻辑，因为 cmake 没有提供类似 vcpkg/conan 等包管理器的安装功能，只提供了包查找特性。</p>

<h4 id="指定版本">指定版本</h4>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"cmake::OpenCV 4.1.1"</span><span class="p">,</span> <span class="p">{</span><span class="n">system</span> <span class="o">=</span> <span class="kc">true</span><span class="p">})</span>
</code></pre>
</div>

<h4 id="指定组件">指定组件</h4>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"cmake::Boost"</span><span class="p">,</span> <span class="p">{</span><span class="n">system</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">configs</span> <span class="o">=</span> <span class="p">{</span><span class="n">components</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"regex"</span><span class="p">,</span> <span class="s2">"system"</span><span class="p">}})}</span>
</code></pre>
</div>

<h4 id="预设开关">预设开关</h4>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"cmake::Boost"</span><span class="p">,</span> <span class="p">{</span><span class="n">system</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">configs</span> <span class="o">=</span> <span class="p">{</span><span class="n">components</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"regex"</span><span class="p">,</span> <span class="s2">"system"</span><span class="p">},</span>
                                             <span class="n">presets</span> <span class="o">=</span> <span class="p">{</span><span class="n">Boost_USE_STATIC_LIB</span> <span class="o">=</span> <span class="kc">true</span><span class="p">}}})</span>
</code></pre>
</div>

<p>相当于内部调用 find_package 查找包之前，在 CMakeLists.txt 中预定义一些配置，控制 find_package 的查找策略和状态。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>set(Boost_USE_STATIC_LIB ON) -- will be used in FindBoost.cmake
find_package(Boost REQUIRED COMPONENTS regex system)
</code></pre>
</div>

<h4 id="设置环境变量">设置环境变量</h4>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"cmake::OpenCV"</span><span class="p">,</span> <span class="p">{</span><span class="n">system</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">configs</span> <span class="o">=</span> <span class="p">{</span><span class="n">envs</span> <span class="o">=</span> <span class="p">{</span><span class="n">CMAKE_PREFIX_PATH</span> <span class="o">=</span> <span class="s2">"xxx"</span><span class="p">}}})</span>
</code></pre>
</div>

<h4 id="指定自定义-findfoocmake-模块脚本目录">指定自定义 FindFoo.cmake 模块脚本目录</h4>

<p>mydir/cmake_modules/FindFoo.cmake</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="n">add_requires</span><span class="p">(</span><span class="s2">"cmake::Foo"</span><span class="p">,</span> <span class="p">{</span><span class="n">system</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">configs</span> <span class="o">=</span> <span class="p">{</span><span class="n">moduledirs</span> <span class="o">=</span> <span class="s2">"mydir/cmake_modules"</span><span class="p">}})</span>
</code></pre>
</div>

<h3 id="在-cmake-中集成-xrepo-依赖包">在 Cmake 中集成 Xrepo 依赖包</h3>

<p>除了可以在 Xmake 中集成 CMake 项目，我们也可以在 CMake 中直接集成 Xmake/Xrepo 提供的包，只需要使用 <a href="https://github.com/xmake-io/xrepo-cmake">xrepo-cmake</a> 提供的 CMake Wrapper。</p>

<p>例如：</p>

<div class="language-cmake highlighter-rouge"><pre class="highlight"><code><span class="nb">cmake_minimum_required</span><span class="p">(</span>VERSION 3.13.0<span class="p">)</span>
<span class="nb">project</span><span class="p">(</span>foo<span class="p">)</span>

<span class="c1"># Download xrepo.cmake if not exists in build directory.</span>
<span class="nb">if</span><span class="p">(</span>NOT EXISTS <span class="s2">"</span><span class="si">${</span><span class="nv">CMAKE_BINARY_DIR</span><span class="si">}</span><span class="s2">/xrepo.cmake"</span><span class="p">)</span>
    <span class="nb">message</span><span class="p">(</span>STATUS <span class="s2">"Downloading xrepo.cmake from https://github.com/xmake-io/xrepo-cmake/"</span><span class="p">)</span>
    <span class="c1"># mirror https://cdn.jsdelivr.net/gh/xmake-io/xrepo-cmake@main/xrepo.cmake</span>
    <span class="nb">file</span><span class="p">(</span>DOWNLOAD <span class="s2">"https://raw.githubusercontent.com/xmake-io/xrepo-cmake/main/xrepo.cmake"</span>
                  <span class="s2">"</span><span class="si">${</span><span class="nv">CMAKE_BINARY_DIR</span><span class="si">}</span><span class="s2">/xrepo.cmake"</span>
                  TLS_VERIFY ON<span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c1"># Include xrepo.cmake so we can use xrepo_package function.</span>
<span class="nb">include</span><span class="p">(</span><span class="si">${</span><span class="nv">CMAKE_BINARY_DIR</span><span class="si">}</span>/xrepo.cmake<span class="p">)</span>

<span class="nf">xrepo_package</span><span class="p">(</span><span class="s2">"zlib"</span><span class="p">)</span>

<span class="nb">add_executable</span><span class="p">(</span>example-bin <span class="s2">""</span><span class="p">)</span>
<span class="nf">target_sources</span><span class="p">(</span>example-bin PRIVATE
    src/main.cpp
<span class="p">)</span>
<span class="nf">xrepo_target_packages</span><span class="p">(</span>example-bin zlib<span class="p">)</span>
</code></pre>
</div>

<h4 id="添加带有配置的包">添加带有配置的包</h4>

<p>我们，也可以跟在 Xmake 中一样，定制包的可选特性。</p>

<div class="language-cmake highlighter-rouge"><pre class="highlight"><code><span class="nf">xrepo_package</span><span class="p">(</span><span class="s2">"gflags 2.2.2"</span> CONFIGS <span class="s2">"shared=true,mt=true"</span><span class="p">)</span>

<span class="nb">add_executable</span><span class="p">(</span>example-bin <span class="s2">""</span><span class="p">)</span>
<span class="nf">target_sources</span><span class="p">(</span>example-bin PRIVATE
    src/main.cpp
<span class="p">)</span>
<span class="nf">xrepo_target_packages</span><span class="p">(</span>example-bin gflags<span class="p">)</span>
</code></pre>
</div>

<h4 id="使用来自第三个存储库的包">使用来自第三个存储库的包</h4>

<p>除了从 Xmake 官方维护的存储库安装软件包之外，我们也可以直接在 CMake 中使用它来安装来自第三方仓库的包，只需将仓库名称添加为命名空间即可。</p>

<p>例如：<code class="highlighter-rouge">vcpkg::zlib</code>, <code class="highlighter-rouge">conan::pcre2</code>。</p>

<div class="language-cmake highlighter-rouge"><pre class="highlight"><code><span class="nf">xrepo_package</span><span class="p">(</span><span class="s2">"conan::gflags/2.2.2"</span><span class="p">)</span>
<span class="nf">xrepo_package</span><span class="p">(</span><span class="s2">"conda::gflags 2.2.2"</span><span class="p">)</span>
<span class="nf">xrepo_package</span><span class="p">(</span><span class="s2">"vcpkg::gflags"</span><span class="p">)</span>
<span class="nf">xrepo_package</span><span class="p">(</span><span class="s2">"brew::gflags"</span><span class="p">)</span>
</code></pre>
</div>

<p>通过这种方式，我们将在 CMake 中集成使用 vcpkg/conan 包的方式进行了统一，并且额外提供了自动包安装特性，以及对 homebrew/conda 等其他包仓库的支持。</p>


        </article>
        <hr>

        <!-- wwads -->
        
        <div class="wwads-cn wwads-horizontal" data-id="243" style="max-width:100%"></div>
        

        <!-- baidu ads -->
        

        <!-- reward -->
        <div style="text-align: center;">
            <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
              <span>赏</span>
            </button>
            <div id="QR" style="display: none;">
                <div id="wechat" style="display: inline-block">
                  <img id="wechat_qr" src="/static/img/weixin.png" alt="WeChat Pay"/>
                  <p>微信打赏</p>
                </div>
                <div id="alipay" style="display: inline-block">
                  <img id="alipay_qr" src="/static/img/alipay.png" alt="Alipay"/>
                  <p>支付宝打赏</p>
                </div>
            </div>
        </div>

        
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
                    
                    <h2 id="english">English</h2>
                    <ul>
                    
                    <li class="relatedPost">
                        <a href="/2022/03/12/xmake-and-package-management/">Xmake and C/C++ Package Management
                        
                        </a>
                    </li>
                    
                    
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
        
            
            
                
            
        
            
        
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
        
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
        
            
            
                
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
            
                
            
        
            
            
                
            
        
            
            
                
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
            
            
                
            
        
            
        
        
            </ul>
        

        
        
            
        
            
            
            
                
                    
                        
                        <h2 id="similar_posts">相关文章</h2>
                        <ul>
                        
                        <li class="relatedPost">
                            <a href="/cn/2023/07/11/xmake-update-v2.8.1/">Xmake v2.8.1 发布，大量细节特性改进
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
            
        
            
        
            
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="/cn/2023/04/04/xmake-update-v2.7.8/">Xmake v2.7.8 发布，改进包虚拟环境和构建速度
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
            
        
            
        
            
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="/cn/2023/02/23/xmake-update-v2.7.7/">Xmake v2.7.7 发布，支持 Haiku 平台，改进 API 检测和 C++ Modules 支持
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
            
        
            
        
            
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="/cn/2023/01/22/xmake-update-v2.7.6/">Xmake v2.7.6 发布，新增 Verilog 和 C++ Modules 分发支持
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
            
        
            
        
            
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="/cn/2022/11/08/xmake-update-v2.7.3/">Xmake v2.7.3 发布，包组件和 C++ 模块增量构建支持
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
            
        
        
            </ul>
        

        <div class="post-recent">
    <div class="pre">

        

        

        
        
        

        

        

        
        
        <p><strong>上一篇</strong> <a href="/cn/2022/03/07/xmake-update-v2.6.4/">xmake v2.6.4 发布，大量包管理特性改进</a></p>
        
    </div>

    <div class="nex">

        

        

        
        
        

        

        

        
        
        <p><strong>下一篇</strong> <a href="/cn/2022/04/24/xmake-update-v2.6.5/">xmake v2.6.5 发布，远程编译支持</a></p>
        
    </div>
</div>


        <h2 id="comments">评论</h2>
        









    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    内容
                </div>
                <ul id="content-side" class="content-ul">
                    <li><a href="#english">English</a></li>
                    <li><a href="#similar_posts">相关文章</a></li>
                    <li><a href="#comments">评论</a></li>
                </ul>
            </div>

            <!-- wwads -->
            
            <div class="side">
            <div class="wwads-cn wwads-vertical" data-id="243" style="max-width:255px;height:250px"></div>
            </div>
            

            <!-- baidu ads -->
            

            <br>
            <div class="side">
                <div>
                    <i class="fa fa-external-link"></i>
                    链接
                </div>
                <ul class="content-ul">
                  <li><a href="http://github.com/waruqi/tbox">tbox</a></li>
                  <li><a href="http://www.xmake.io">xmake</a></li>
                  <li><a href="https://github.com/waruqi">github</a></li>
                </ul>
            </div>

            <!-- xmake courses -->
            <br>
            <div class="side">
                <div>
                    <i class="fa fa-external-link"></i>
                    xmake 入门课程
                </div>
                <a href="https://xmake.io/#/zh-cn/about/course" target="_blank">
                <img src="/static/img/xmake-course.png" alt="course" width="256" height="193">
                </a>
            </div>

            <!-- qqgroup -->
            <br>
            <div class="side">
                <div>
                    <i class="fa fa-external-link"></i>
                    技术交流群（QQ）
                </div>
                <img src="/static/img/qqgroup.png" alt="qqgroup" width="256" height="284">
            </div>

            <!-- google ads -->
            

            <!-- baidu ads -->
            

        </div>
    </div>

    <!-- baidu ads -->
    
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>



    <footer class="site-footer">
    <div class="wrapper">
        <p class="description">
             Copyright (c) 2016-latest tboox.org 
        </p>
        <p class="contact">
            
            <a href="https://github.com/waruqi" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a> 
             
            
            <a href="mailto:waruqi@gmail.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a> 
            
            
            <a href="https://twitter.com/waruqi" title="Twitter"><i class="fa fa-twitter" aria-hidden="true"></i></a> 
            
            <a href="/feed.xml" title="feed"><i class="fa fa-feed" aria-hidden="true"></i></a> 
        </p>
        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://github.com/Gaohaoyang">HyG</a> & <a href="https://pages.github.com/">Github Pages</a>.
            </span>
        </p>
    </div>
</footer>

    <div class="back-to-top">
    <a href="#top" class="scroll">
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/scroll.min.js " charset="utf-8"></script>
  </body>

</html>
